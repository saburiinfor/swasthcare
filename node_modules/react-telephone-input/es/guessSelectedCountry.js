// memoize results based on the first 5/6 characters. That is all that matters

import R from 'cramda';
import countryData from 'country-telephone-data';

var find = R.find,
    propEq = R.propEq,
    startsWith = R.startsWith;
var allCountries = countryData.allCountries,
    allCountryCodes = countryData.allCountryCodes;


export default function guessSelectedCountry(inputNumber, props) {
  var defaultCountry = props.defaultCountry,
      onlyCountries = props.onlyCountries;


  var secondBestGuess = find(propEq('iso2', defaultCountry), allCountries) || onlyCountries[0];

  var inputNumberForCountries = inputNumber.substr(0, 4);
  var bestGuess = void 0;

  if (inputNumber.trim() !== '') {
    bestGuess = onlyCountries.reduce(function (selectedCountry, country) {
      // if the country dialCode exists WITH area code

      if (allCountryCodes[inputNumberForCountries] && allCountryCodes[inputNumberForCountries][0] === country.iso2) {
        return country;

        // if the selected country dialCode is there with the area code
      } else if (allCountryCodes[inputNumberForCountries] && allCountryCodes[inputNumberForCountries][0] === selectedCountry.iso2) {
        return selectedCountry;

        // else do the original if statement
      }
      if (startsWith(country.dialCode, inputNumber)) {
        if (country.dialCode.length > selectedCountry.dialCode.length) {
          return country;
        }
        if (country.dialCode.length === selectedCountry.dialCode.length && country.priority < selectedCountry.priority) {
          return country;
        }
      }

      return selectedCountry;
    }, { dialCode: '', priority: 10001 }, this);
  } else {
    return secondBestGuess;
  }

  if (!bestGuess || !bestGuess.name) {
    return secondBestGuess;
  }

  return bestGuess;
}